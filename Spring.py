import streamlit as st
import math
from datetime import datetime

# ---------- å›ºå®šåƒæ•¸ ----------
G = 8000  # kgf/mm^2 ï¼ˆå½ˆç°§é‹¼æ€§æ¨¡æ•¸çš„é è¨­å€¼ï¼‰

# ---------- è‡ªè¨‚æµ®é»ç¯„åœç”¢ç”Ÿå™¨ ----------
def frange(start, stop, step):
    """æ¨¡æ“¬ Python çš„ rangeï¼Œä½†æ”¯æ´å°æ•¸"""
    while start <= stop:
        yield round(start, 2)
        start += step

# ---------- æ˜Ÿæ˜Ÿå¾—åˆ† ----------
def score_to_stars(score):
    """å°‡è©•åˆ† (0~4) è½‰æ›æˆ â˜…/â˜† é¡¯ç¤º"""
    return 'â˜…' * score + 'â˜†' * (4 - score)

# ---------- ä¸»ç¨‹å¼ ----------
def main():
    """å£“ç¸®å½ˆç°§çµ„åˆè¨ˆç®—å™¨ä¸»ç¨‹å¼ï¼ˆStreamlit å…¥å£ï¼‰"""

    # é é¢åŸºæœ¬è¨­å®š
    st.set_page_config(page_title="å£“ç¸®å½ˆç°§çµ„åˆè¨ˆç®—å™¨", page_icon="ğŸ§®")
    st.title("ğŸ§® å£“ç¸®å½ˆç°§çµ„åˆè¨ˆç®—å™¨")

    # ---------- è¼¸å…¥è¡¨å–® ----------
    with st.form("spring_form"):
        st.subheader("ğŸ“Œ è«‹è¼¸å…¥åƒæ•¸")
        L = st.number_input("CPUé•·åº¦ (mm)", min_value=1.0, value=25.0)
        W = st.number_input("CPUå¯¬åº¦ (mm)", min_value=1.0, value=25.0)
        G = st.number_input("å½ˆç°§é‹¼æ€§æ¨¡æ•¸ (kgf/mmÂ²)", min_value=1.0, value=8000.0)
        SS = st.number_input("èºçµ²è¡Œç¨‹ (mm)", min_value=0.1, value=0.3)
        SRU = st.number_input("Spring Room Unlock (mm)", min_value=0.1, value=2.5)
        SSD = st.number_input("èºçµ²æ¡¿å¾‘ (mm)", min_value=0.1, value=1.2)
        SHD = st.number_input("èºçµ²é ­å¾‘ (mm)", min_value=SSD + 0.01, value=2.4)
        CPSI = st.number_input("æ™¶ç‰‡æ‰¿å—æœ€å¤§è² è¼‰ (lbf/inÂ²)", min_value=1.0, value=40.0)
        SNN = st.number_input("èºçµ²æ•¸é‡ (pcs)", min_value=1, step=1, value=4)
        N = st.number_input("é¡¯ç¤ºçµ„åˆæ•¸é‡", min_value=1, step=1, value=5)
        submitted = st.form_submit_button("ğŸš€ é–‹å§‹è¨ˆç®—")

    # ---------- è¨ˆç®— ----------
    if submitted:
        st.subheader("ğŸ“ è¼¸å…¥åƒæ•¸ç¢ºèª")
        st.markdown(f"""
        - CPUé•·åº¦ï¼š{L} mm  
        - CPUå¯¬åº¦ï¼š{W} mm  
        - å½ˆç°§é‹¼æ€§æ¨¡æ•¸ï¼š{G} kgf/mmÂ²  
        - èºçµ²è¡Œç¨‹ï¼š{SS} mm  
        - Spring Room Unlockï¼š{SRU} mm  
        - èºçµ²æ¡¿å¾‘ï¼š{SSD} mm  
        - èºçµ²é ­å¾‘ï¼š{SHD} mm  
        - æ™¶ç‰‡æœ€å¤§è² è¼‰ï¼š{CPSI} lbf/inÂ²  
        - èºçµ²æ•¸é‡ï¼š{SNN} pcs  
        - é¡¯ç¤ºçµ„åˆæ•¸é‡ï¼š{N} çµ„  
        """)

        # æ™¶ç‰‡è² è¼‰å…è¨±ç¯„åœ (Â±10%)
        PSI_lower = CPSI * 0.9
        PSI_upper = CPSI * 1.1
        valid_combinations = []

        # ---------- è¨ˆç®—æ‰€æœ‰çµ„åˆ ----------
        for WD in frange(0.2, 1.0, 0.1):  # ç·šå¾‘
            ID_min = SSD + 0.01
            ID_max = SHD - 0.01
            for ID in frange(ID_min, ID_max, 0.1):  # å…§å¾‘
                for SN in frange(3, 20, 1):  # ç¸½åœˆæ•¸
                    NC = SN - 2  # æœ‰æ•ˆåœˆæ•¸
                    if NC <= 0:
                        continue
                    OD = round(ID + 2*WD, 2)  # å¤–å¾‘
                    MD = round(ID + WD, 2)    # ä¸­å¾‘
                    SK = round((G * WD**4) / (8 * MD**3 * NC), 2)  # å½ˆç°§å¸¸æ•¸
                    SL = round((SN + 1) * WD, 2)  # å¯†å¯¦é«˜åº¦

                    FL_min = SL + 0.1
                    FL_max = SRU + SL
                    for FL in frange(FL_min, FL_max, 0.5):  # è‡ªç”±é•·åº¦
                        SP = round(FL - SRU, 2)  # é å£“
                        if SP <= 0:
                            continue
                        SPP = round(FL / SN, 2)  # ç¯€è·
                        ST = round(SP + SS, 2)   # è¡Œç¨‹
                        SCC = round(ST + SL, 2)  # å£“ç¸®ç¢ºèª
                        if SCC > FL:
                            continue
                        DF = round(ST * SK, 2)   # è¡Œç¨‹å£“åŠ›
                        TFK = round(DF * SNN, 2) # æ¨¡çµ„ç¸½å£“åŠ› (kgf)
                        TFL = round(TFK * 2.2046, 2) # æ¨¡çµ„ç¸½å£“åŠ› (lbf)
                        PSI = round((TFK / (L * W)) * 1421.0573, 2) # æ™¶ç‰‡è² è¼‰

                        # ---------- æ¢ä»¶æª¢æŸ¥ ----------
                        cond1 = PSI_lower <= PSI <= PSI_upper  # æ™¶ç‰‡è² è¼‰å…è¨±
                        cond2 = SP > 0                         # é å£“å¿…é ˆ > 0
                        cond3 = SPP < 2.5                      # ç¯€è·ä¸å®œéå¤§
                        cond4 = SL >= FL*0.75                  # å£“ç¸®æ¯”ä¾‹åˆç†
                        score = sum([cond1, cond2, cond3, cond4])

                        # ç´€éŒ„ä¸ç¬¦åˆåŸå› 
                        notes = []
                        if not cond1: notes.append(f"PSIè¶…å‡ºç¯„åœ â†’ {PSI} lbf/inÂ²")
                        if not cond2: notes.append(f"é å£“ä¸è¶³ â†’ {SP} mm")
                        if not cond3: notes.append(f"ç¯€è·éå¤§ â†’ {SPP} mm")
                        if not cond4: notes.append(f"å£“ç¸®ä¸è¶³ â†’ è‡ªç”±é•·åº¦ï¼š{FL} mm, å¯†å¯¦é«˜åº¦ï¼š{SL} mm")

                        # ç¬¦åˆæ¢ä»¶æ‰åŠ å…¥æ¸…å–®
                        if score >= 2:
                            valid_combinations.append({
                                "ç·šå¾‘": WD, "å…§å¾‘": ID, "å¤–å¾‘": OD, "ä¸­å¿ƒå¾‘": MD,
                                "ç¸½åœˆæ•¸": SN, "æœ‰æ•ˆåœˆæ•¸": NC, "è‡ªç”±é•·åº¦": FL, "å¯†å¯¦é«˜åº¦": SL,
                                "é å£“": SP, "ç¯€è·": SPP, "Spring Room Locked": SRU - SS,
                                "è¡Œç¨‹": ST, "å£“ç¸®ç¢ºèª": SCC, "è¡Œç¨‹å£“åŠ›": DF,
                                "æ¨¡çµ„ç¸½å£“åŠ›(kgf)": TFK, "æ¨¡çµ„ç¸½å£“åŠ›(lbf)": TFL,
                                "æ™¶ç‰‡è² è¼‰": PSI, "è©•åˆ†": score, "ä¸ç¬¦åˆåŸå› ": notes
                            })

        # ---------- é¡¯ç¤ºçµæœ ----------
        if not valid_combinations:
            st.warning("âŒ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„çµ„åˆï¼Œè«‹å˜—è©¦èª¿æ•´åƒæ•¸ã€‚")
        else:
            valid_combinations.sort(key=lambda x: -x['è©•åˆ†'])
            available = len(valid_combinations)
            st.success(f"âœ… æ‰¾åˆ° {available} çµ„ç¬¦åˆæ¢ä»¶çš„çµ„åˆã€‚é¡¯ç¤ºå‰ {min(N, available)} çµ„ï¼š")
            for i, combo in enumerate(valid_combinations[:N]):
                stars_display = score_to_stars(combo['è©•åˆ†'])
                with st.expander(f"ç¬¬ {i+1} çµ„ï¼ˆæ»¿è¶³æ¢ä»¶ï¼š{stars_display}ï¼‰", expanded=True):
                    for k, v in combo.items():
                        if k != "ä¸ç¬¦åˆåŸå› " and k != "è©•åˆ†":
                            st.write(f"{k}: {v}")
                    if combo["ä¸ç¬¦åˆåŸå› "]:
                        st.markdown(
                            f"<div style='background-color:#fff3cd; padding:8px; border-radius:5px;'>âš  ä¸ç¬¦åˆæ¢ä»¶ï¼š</div>",
                            unsafe_allow_html=True
                        )
                        for note in combo["ä¸ç¬¦åˆåŸå› "]:
                            st.write(note)
                    else:
                        st.markdown(
                            f"<div style='background-color:#d1ecf1; padding:8px; border-radius:5px;'>âš  ä¸ç¬¦åˆæ¢ä»¶ï¼š ç„¡</div>",
                            unsafe_allow_html=True
                        )

    # ---------- é¡¯ç¤ºæœ€å¾Œæ›´æ–°æ™‚é–“ ----------
    st.write("æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))


# å…è¨±ç›´æ¥åŸ·è¡Œ Spring.pyï¼Œä¹Ÿèƒ½è¢« app.py åŒ¯å…¥
if __name__ == "__main__":
    main()

#----------ä»¥ä¸‹è¨Šæ¯ä¿ç•™ ----------
#ä½¿ç”¨è€…è‡ªè¡Œè¼¸å…¥æ•¸å€¼(ä¸æœƒæœ‰è² å€¼)
#1.*"L"ä»£è¡¨CPUé•·åº¦*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#2.*"W"ä»£è¡¨CPUå¯¬åº¦*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#3.*"G"ä»£è¡¨å½ˆç°§é‹¼æ€§æ¨¡æ•¸*ï¼Œæµ®é»æ•¸
#4.*"SS"ä»£è¡¨èºçµ²è¡Œç¨‹*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#5.*"SRU"ä»£è¡¨Spring Room Unlock*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#6.*"SSD"èºçµ²æ¡¿å¾‘*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#7.*"SHD"èºçµ²é ­å¾‘*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½mm
#8.*"CPSI"ä»£è¡¨å®¢æˆ¶è¦æ±‚æ™¶ç‰‡æ‰¿å—æœ€å¤§è² è¼‰*ï¼Œæµ®é»æ•¸ï¼Œå–®ä½lbf/in^2
#9.*"SNN"ä»£è¡¨èºçµ²æ•¸é‡*ï¼Œæ•´æ•¸ï¼Œå–®ä½pcs
#10.*"N"ä»£è¡¨é¡¯ç¤ºçµ„åˆæ•¸é‡*ï¼Œæ•´æ•¸ï¼Œå–®ä½groups

#ç¯„åœè®Šæ•¸(ä¸æœƒæœ‰è² å€¼ï¼Œé€épythonè¨ˆç®—å‡ºæœ€ä½³åŒ–åƒæ•¸ï¼Œä¸æœƒç”±ä½¿ç”¨è€…è¼¸å…¥)
#1.*"WD"ä»£è¡¨ç·šå¾‘*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼Œç¯„åœ1>=WD>=0.2ï¼Œé–“éš”0.1ï¼Œå–®ä½mm
#2.*"ID"ä»£è¡¨å…§å¾‘*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼Œç¯„åœSHD>ID>SSDï¼Œå–®ä½mm
#3.*"SN"ä»£è¡¨å½ˆç°§ç¸½åœˆæ•¸*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾Œä¸€ä½)ï¼Œç¯„åœSN>0ï¼Œå–®ä½laps
#4.*"FL"ä»£è¡¨å½ˆç°§è‡ªç”±é•·åº¦*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼Œå–®ä½mm

#è¨ˆç®—å…¬å¼(ä¸æœƒæœ‰è² å€¼)
#1.*"OD"ä»£è¡¨å½ˆç°§å¤–å¾‘*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒID+2*WDï¼Œå–®ä½mm
#2.*"MD"ä»£è¡¨å½ˆç°§ä¸­å¿ƒå¾‘*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒWD+IDï¼Œå–®ä½mm
#3.*"NC"ä»£è¡¨å½ˆç°§æœ‰æ•ˆåœˆæ•¸*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾Œä¸€ä½)ï¼ŒSN-2ï¼Œå–®ä½laps
#4.*"SK"ä»£è¡¨å½ˆç°§å¸¸æ•¸*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)(G*WD^4)/(8*MD^3*NC)ï¼Œå–®ä½kgf/mm
#5.*"SL"ä»£è¡¨å½ˆç°§å¯†å¯¦é«˜åº¦*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼Œ(SN+1)*WDï¼Œå–®ä½mm
#6.*"SP"ä»£è¡¨å½ˆç°§é å£“*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒFL-SRUï¼Œå–®ä½mm
#7.*"SPP"ä»£è¡¨å½ˆç°§ç¯€è·*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒFL/SNï¼Œå–®ä½mm
#8.*"SRL"ä»£è¡¨Spring Room Locked*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒSRU-SSï¼Œå–®ä½mm
#9.*"ST"ä»£è¡¨å½ˆç°§è¡Œç¨‹(å«é å£“è¡Œç¨‹)*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒSP+SSï¼Œå–®ä½mm
#10.*"SCC"ä»£è¡¨å½ˆç°§å£“ç¸®ç¢ºèª*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒST+SLï¼Œå–®ä½mm
#11.*"DF"ä»£è¡¨è¡Œç¨‹å£“åŠ›*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒST*SKï¼Œå–®ä½kg
#12.*"TFK"ä»£è¡¨æ¨¡çµ„ä¸Šçš„å½ˆç°§ç¸½å£“åŠ›*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒDF*SNNï¼Œå–®ä½kgf
#13.*"TFL"ä»£è¡¨æ¨¡çµ„ä¸Šçš„å½ˆç°§ç¸½å£“åŠ›*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒTFK*2.2046ï¼Œå–®ä½lbf
#14.*"PSI"ä»£è¡¨æ™¶ç‰‡æ‰¿å—æœ€å¤§è² è¼‰*ï¼Œæµ®é»æ•¸(é¡¯ç¤ºå°æ•¸é»å¾ŒäºŒä½)ï¼ŒTFK/(L*W)*1421.0573ï¼Œå–®ä½lbf/in^2

#æœ€ä½³åŒ–ç›®æ¨™(ä¸æœƒæœ‰è² å€¼)
#1.CPSI+(CPSI*10%)>PSI>CPSI-(CPSI*10%)ï¼Œ*è¦æ»¿è¶³æ™¶ç‰‡æ‰¿å—æœ€å¤§è² è¼‰çš„+/-10%*
#2.SP>0ï¼Œ*å½ˆç°§è¦æœ‰é å£“*
#3.SPP<2.5ï¼Œ*å½ˆç°§ç¯€è·è¦å°æ–¼2.5*
#4.FL>SL>FL*75%ï¼Œ*å¯†å¯¦å½ˆç°§å£“ç¸®å¾Œä¸èƒ½ä½æ–¼è‡ªç”±é•·åº¦75%*
#5.æœ€å¥½æƒ…æ³æ˜¯1.2.3.4é»éƒ½æ»¿è¶³ï¼Œå¦å‰‡è‡³å°‘è¦æ»¿è¶³1.2é»ï¼Œå…¶é¤˜åƒæ•¸å‰‡ç‚ºä¸ç¬¦åˆè¦æ±‚
#6.è¼¸å‡ºçš„çµ„åˆè«‹å¾æœ€ä½³é–‹å§‹æ’åˆ—

#é¡å¤–æ¢ä»¶
#1.ä½¿ç”¨è€…è‡ªè¡Œè¼¸å…¥æ•¸å€¼æ™‚ï¼Œå¿…é ˆæ˜¯SHD>SSDï¼Œå¦‚æœä¸ç¬¦åˆä¸Šè¿°è¦æ±‚æ™‚ï¼Œé¡¯ç¤º"èºçµ²æ¡¿å¾‘éœ€å°æ–¼èºçµ²é ­å¾‘"ï¼Œä¸¦ä¸”é‡æ–°å¾ç¬¬6é»é–‹å§‹è¼¸å…¥
#2.ç•¶è¨ˆç®—çµæœSCC>FLæ™‚ï¼Œä»£è¡¨éŒ¯èª¤ï¼Œç›´æ¥æ’é™¤è©²çµ„åˆï¼Œä¸é¡¯ç¤ºåœ¨çµæœ
#3.ç•¶è¼¸å…¥çš„N(é¡¯ç¤ºçµ„åˆæ•¸é‡)ï¼Œç„¡æ³•æ»¿è¶³æ™‚ï¼Œè«‹æä¾›æœ€å¤§çš„å»ºè­°å€¼ï¼Œä¸¦ç›´æ¥è«‹ä½¿ç”¨è€…å†æ¬¡è¼¸å…¥çµ„åˆæ•¸é‡
#4.ç•¶ä½¿ç”¨è€…æ²’æœ‰è¼¸å…¥æ•¸å€¼æ™‚ï¼Œé¡¯ç¤º"è«‹é‡æ–°è¼¸å…¥æ•¸å€¼"ï¼Œä¸¦å†æ¬¡è·³å‡ºè©²æ¬„ä½
#5.ç•¶ä½¿ç”¨è€…è¼¸å…¥å®Œæ‰€æœ‰æ¢ä»¶æ™‚ï¼Œå†å‡ºç¾çµæœå‰ï¼Œæœƒå…ˆé¡¯ç¤ºç•¶å‰è¼¸å…¥çš„æ•¸å€¼åˆ—è¡¨ï¼Œæ‰æœƒåœ¨é¡¯ç¤ºçµæœ
#6.è¼¸å‡ºçš„çµæœä¸é¡¯ç¤ºä»£è™Ÿï¼Œä½†éƒ½è¦æœ‰å–®ä½é¡¯ç¤º
#7.æœ€å¥½çš„æƒ…æ³èƒ½æ»¿è¶³ç¬¬1.2.3.4é»ï¼Œä½†ç„¡æ³•é”æˆæ™‚ï¼Œè«‹è‡³å°‘æ»¿è¶³å…¶ä¸­ä»»2é»å’Œé¡¯ç¤ºå“ªä¸€é»ç„¡æ³•é”åˆ°(éœ€é¡¯ç¤ºç•¶å‰è¨ˆç®—æ•¸å€¼)ï¼Œä¸¦ä¸”é”æˆNé»æ™‚ï¼Œæœƒç”¨æ˜Ÿæ˜Ÿç¬¦è™Ÿè¡¨ç¤º(æ»¿è¶³4é»å‰‡æœƒæœ‰4é¡†æ˜Ÿæ˜Ÿ)
#8.**å…§çš„æ–‡å­—è¨»æ˜åœ¨ç¨‹å¼å…§ï¼Œä»¥ä¾¿ç¢ºèªç¨‹å¼å…§å®¹